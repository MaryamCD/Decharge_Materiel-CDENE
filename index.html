<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>D√©charge du Mat√©riel ‚Äì CD√âN√â</title>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f9fa; color: #222; padding: 25px; }
  #enTetePDF { text-align:center; margin-bottom:20px; }
  #enTetePDF img { width:120px; height:auto; display:block; margin:0 auto 10px; }
  h1 { color:#003a70; margin:0; }
  .instructions { max-width:900px; margin:0 auto 20px auto; background:#e9f2f1; border-bottom:6px solid #1e4f38; padding:12px 18px; border-radius:6px; line-height:1.5; }
  .bloc-formulaire { background-color: #c9d9e8; border: 1px solid #6885a5; border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); page-break-inside: avoid; max-width: 900px; margin-left:auto; margin-right:auto; }
  fieldset { border:2px solid #1e4f38; border-radius:8px; padding:16px; }
  legend { font-weight:700; color:#003a70; font-size:1.05em; }
  label { display:block; margin-top:10px; font-weight:700; }
  input, select, textarea { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #888; box-sizing:border-box; font-size:14px; }
  textarea, .bloc-texte { overflow: visible !important; height:auto !important; min-height:80px; white-space: pre-wrap; word-wrap: break-word; }
  .two-col { display:flex; gap:12px; }
  .two-col > div { flex:1; }
  button { background: #003366; color:#fff; padding:10px 18px; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
  button:hover { background:#0055aa; }
  .center { text-align:center; margin:20px 0; }
  #adminPanel { display:none; max-width:900px; margin:0 auto 20px auto; padding:12px; border:1px solid #ddd; background:#fafafa; border-radius:8px; }
  .admin-toggle { color:#003366; cursor:pointer; text-decoration:underline; margin-bottom:8px; display:inline-block; }
</style>
</head>
<body>

<!-- header -->
<div id="enTetePDF">
  <img src="https://www.cdene.ns.ca/sites/default/files/inline-images/logo_cdene.png" alt="Logo CD√âN√â" />
  <h1>D√©charge du Mat√©riel ‚Äì CD√âN√â</h1>
</div>

<p id="instructionsPDF" class="instructions">
  Ce formulaire est utilis√© pour documenter <strong>l‚Äôattribution, le suivi et la restitution</strong> des biens du CD√âN√â dans le cadre du cycle d‚Äôemploi d‚Äôun collaborateur. Il doit √™tre compl√©t√© par le gestionnaire direct ou son repr√©sentant. Une fois rempli, il doit √™tre archiv√© et transmis aux ressources humaines.
</p>

<!-- admin panel toggle -->
<div class="center">
  <span class="admin-toggle" onclick="toggleAdminPanel()">‚öôÔ∏è Afficher panneau admin</span>
</div>

<!-- admin panel -->
<div id="adminPanel">
  <h3>Panneau administrateur</h3>
  <label><input type="checkbox" id="chkAttribution" onclick="toggleBloc('blocAttribution')"> Montrer Attribution</label>
  <label><input type="checkbox" id="chkSuivi" onclick="toggleBloc('blocSuivi')"> Montrer Suivi</label>
  <label><input type="checkbox" id="chkDecharge" onclick="toggleBloc('blocD√©charge')"> Montrer D√©charge</label>
</div>

<!-- FORMULAIRES -->
<div id="formMateriel">

  <!-- BLOC 1 : Attribution -->
  <form id="blocAttribution" class="bloc-formulaire" style="display:none;">
    <fieldset>
      <legend>Attribution du mat√©riel</legend>
      <div class="two-col">
        <div><label>Nom de l‚Äôemploy√©</label><input type="text" id="nomAttribution" /></div>
        <div><label>Nom du Gestionnaire</label><input type="text" id="gestionnaireAttribution" /></div>
      </div>
      <label>Type de mat√©riel</label>
      <select id="typeMateriel1" onchange="majChamps('1')">
        <option value="">-- S√©lectionnez --</option>
        <option>Ordinateur/Laptop</option>
        <option>Cl√©s_Bureau</option>
        <option>Badge d'acc√®s</option>
        <option>Ligne t√©l√©phonique pro</option>
        <option>Moniteur</option>
        <option>Accessoires</option>
        <option>Tablette</option>
        <option>Cellulaire</option>
        <option>Casque</option>
        <option>Autres</option>
      </select>
      <div id="blocAutres1" style="display:none;"><label>Autres</label><input type="text" id="Autres1" placeholder="Veuillez pr√©ciser..." /></div>
      <div id="blocMarque1" style="display:none;"><label>Marque</label><input type="text" id="marque1" /></div>
      <div id="blocNomOrdinateur1" style="display:none;"><label>Nom de l‚Äôordinateur</label><input type="text" id="nomOrdi1" /></div>
      <div id="blocNumeroSerie1" style="display:none;"><label>Num√©ro de s√©rie</label><input type="text" id="serie1" /></div>
      <div class="two-col">
        <div><label>Date</label><input type="date" id="date1" /></div>
        <div><label>√âtat du mat√©riel</label>
          <select id="etat1"><option value="">-- S√©lectionnez --</option><option>Nouveau</option><option>Provenant d'un autre projet</option><option>Ancien</option></select>
        </div>
      </div>
      <label>Commentaire (optionnel)</label><textarea id="comment1" placeholder="Remarques, configuration,‚Ä¶"></textarea>
      <label>D√©claration de l‚Äôemploy√©</label><textarea readonly class="bloc-texte">L'employeur reconnait avoir re√ßu tout mat√©riel informatique, cl√©, badge, √©quipement divers, des documents physiques ou √©lectroniques remplis dans ce formulaire.</textarea>
      <label>R√©serves √©ventuelles</label><textarea readonly class="bloc-texte">L'employeur se r√©serve le droit de r√©clamer r√©paration ou d√©duction financi√®re si du mat√©riel est jug√© manquant, endommag√© ou non fonctionnel au-del√† de l'usure normale.</textarea>
      <label>Date du signature</label><input type="date" id="dateRestitution1" />
      <div class="two-col">
        <div><label>Signature du gestionnaire</label><input type="text" id="signatureEmployeur1" placeholder="Nom / signature" /></div>
        <div><label>Signature de l‚Äôemploy√©</label><input type="text" id="signatureEmploye1" placeholder="Nom / signature" /></div>
      </div>
    </fieldset>
  </form>

  <!-- BLOC 2 : Suivi -->
  <form id="blocSuivi" class="bloc-formulaire" style="display:none;">
    <fieldset>
      <legend>Suivi / Mise √† jour</legend>
      <div class="two-col">
        <div><label>Nom de l‚Äôemploy√©</label><input type="text" id="nomSuivi" /></div>
        <div><label>Nom du gestionnaire</label><input type="text" id="gestionnaireSuivi" /></div>
      </div>
      <label>Description / Action</label>
      <select id="Description" onchange="majChamps('2')">
        <option value="">-- S√©lectionnez --</option>
        <option>Ajout</option>
        <option>Changement</option>
        <option>Retour des mat√©riels</option>
        <option>Autres</option>
      </select>
      <label>Type de mat√©riel</label>
      <select id="typeMateriel2" onchange="majChamps('2')">
        <option value="">-- S√©lectionnez --</option>
        <option>Ordinateur/Laptop</option>
        <option>Cl√©s_Bureau</option>
        <option>Badge d'acc√®s</option>
        <option>Ligne t√©l√©phonique pro</option>
        <option>Moniteur</option>
        <option>Accessoires</option>
        <option>Tablette</option>
        <option>Cellulaire</option>
        <option>Casque</option>
        <option>Autres</option>
      </select>
      <div id="blocAutres2" style="display:none;"><label>Autres</label><input type="text" id="Autres2" placeholder="Veuillez pr√©ciser..." /></div>
      <div id="blocMarque2" style="display:none;"><label>Marque</label><input type="text" id="marque2" /></div>
      <div id="blocNomOrdinateur2" style="display:none;"><label>Nom de l‚Äôordinateur</label><input type="text" id="nomOrdi2" /></div>
      <div id="blocNumeroSerie2" style="display:none;"><label>Num√©ro de s√©rie</label><input type="text" id="serie2" /></div>
      <div class="two-col">
        <div><label>Date</label><input type="date" id="date2" /></div>
        <div><label>√âtat du mat√©riel</label>
          <select id="etat2"><option>Nouveau</option><option>Provenant d'un autre projet</option><option>Ancien</option></select>
        </div>
      </div>
      <label>Commentaire (optionnel)</label><textarea id="comment2"></textarea>
      <label>D√©claration de l‚Äôemploy√©</label><textarea readonly class="bloc-texte">L'employeur reconnait avoir re√ßu tout mat√©riel informatique, cl√©, badge, √©quipement divers, des documents physiques ou √©lectroniques remplis dans ce formulaire.</textarea>
      <label>R√©serves √©ventuelles</label><textarea readonly class="bloc-texte">L'employeur se r√©serve le droit de r√©clamer r√©paration ou d√©duction financi√®re si du mat√©riel est jug√© manquant, endommag√© ou non fonctionnel au-del√† de l'usure normale.</textarea>
      <label>Date du signature</label><input type="date" id="dateRestitution2" />
      <div class="two-col">
        <div><label>Signature du gestionnaire</label><input type="text" id="signatureEmployeur2" placeholder="Nom / signature" /></div>
        <div><label>Signature de l‚Äôemploy√©</label><input type="text" id="signatureEmploye2" placeholder="Nom / signature" /></div>
      </div>
    </fieldset>
  </form>

  <!-- BLOC 3 : D√©charge -->
  <form id="blocD√©charge" class="bloc-formulaire" style="display:none;">
    <fieldset>
      <legend>D√©charge / Restitution-Mat√©riel</legend>
      <label>Dernier jour de travail</label><input type="date" id="dernierJour" />
      <label>Mat√©riel restitu√© (cochez si applicable)</label>
      <div id="checkboxRestitution">
        <label><input type="checkbox" /> Cl√©s du bureau</label>
        <label><input type="checkbox" /> Badge d‚Äôacc√®s</label>
        <label><input type="checkbox" /> Ligne t√©l√©phonique professionnelle</label>
        <label><input type="checkbox" /> Ordinateur / Laptop</label>
        <label><input type="checkbox" /> Moniteur</label>
        <label><input type="checkbox" /> Tablette</label>
        <label><input type="checkbox" /> Accessoires</label>
        <label><input type="checkbox" /> Autres</label>
      </div>
      <div id="blocAccessoires3" style="display:none; margin-top:10px;"><label>Pr√©cisez les accessoires</label><input type="text" id="Accessoires3" /></div>
      <div id="blocAutres3" style="display:none; margin-top:10px;"><label>Autres mat√©riels</label><input type="text" id="Autres3" /></div>
      <label>D√©claration de l‚Äôemploy√©</label><textarea readonly class="bloc-texte">L'employeur d√©clare qu'il n'a plus en sa possession aucun bien appartenant au CD√âN√â, et avoir compl√©t√© la passation de consignes avant son d√©part.</textarea>
      <label>R√©serves √©ventuelles</label><textarea readonly class="bloc-texte">L'employeur se r√©serve le droit de r√©clamer r√©paration ou d√©duction financi√®re si du mat√©riel est jug√© manquant, endommag√© ou non fonctionnel au-del√† de l'usure normale.</textarea>
      <label>Date de restitution</label><input type="date" id="dateRestitution3" />
      <div class="two-col">
        <div><label>Nom de l'employ√©</label><input type="text" id="NomEmploy√©Restitution" /></div>
        <div><label>Nom du gestionnaire</label><input type="text" id="NomGestionnaireRestitution" /></div>
      </div>
      <div class="two-col">
        <div><label>Signature de l‚Äôemploy√©</label><input type="text" id="signatureEmploye3" /></div>
        <div><label>Signature du gestionnaire</label><input type="text" id="signatureGestionnaire3" /></div>
      </div>
    </fieldset>
  </form>

</div>

<div class="center">
  <button id="btnDownloadPDF">üìÑ T√©l√©charger PDF</button>
</div>
<script>
(function(){
  const params = new URLSearchParams(window.location.search);
  const bloc = params.get('bloc'); // ?bloc=attribution ou suivi ou decharge
  const admin = params.get('admin'); // ?admin=1
  if (bloc) {
    const id = bloc==='attribution'?'blocAttribution':bloc==='suivi'?'blocSuivi':'blocDecharge';
    document.getElementById(id).style.display='block';
  }
</script>
<script>
// ---- Admin ----
function toggleAdminPanel() {
  const panel = document.getElementById('adminPanel');
  if (panel.style.display === 'none' || panel.style.display === '') {
    const mdp = prompt("‚öôÔ∏è Entrez le mot de passe administrateur :");
    if (mdp === "admin123") panel.style.display = 'block';
    else alert("Mot de passe incorrect ! Le panneau admin restera cach√©.");
  } else panel.style.display = 'none';
}

// ---- Blocs dynamiques ----
function majChamps(bloc) {
  const type = document.getElementById('typeMateriel' + bloc).value;
  const showMarque = ['Ordinateur/Laptop','Tablette','Accessoires','Cellulaire','Moniteur'];
  const blocMarque = document.getElementById('blocMarque'+bloc);
  const blocNomOrdi = document.getElementById('blocNomOrdinateur'+bloc);
  const blocSerie = document.getElementById('blocNumeroSerie'+bloc);
  const blocAutres = document.getElementById('blocAutres'+bloc);
  let blocAccessoire = document.getElementById('blocAccessoire'+bloc);
  if (!blocAccessoire) {
    blocAccessoire = document.createElement('div');
    blocAccessoire.id = 'blocAccessoire'+bloc;
    blocAccessoire.style.display='none';
    blocAccessoire.innerHTML=`<label>Type d‚Äôaccessoire</label><input type="text" id="accessoire${bloc}" placeholder="Ex: Souris, Clavier, Docking..." />`;
    if (blocMarque) blocMarque.after(blocAccessoire);
  }
  if (blocMarque) blocMarque.style.display = showMarque.includes(type)?'block':'none';
  if (blocNomOrdi) blocNomOrdi.style.display = (type==='Ordinateur/Laptop')?'block':'none';
  if (blocSerie) blocSerie.style.display = showMarque.includes(type)?'block':'none';
  if (blocAutres) blocAutres.style.display = (type==='Autres')?'block':'none';
  if (blocAccessoire) blocAccessoire.style.display = (type==='Accessoires')?'block':'none';
}

function toggleBloc(id) {
  const bloc = document.getElementById(id);
  if (!bloc) return;
  bloc.style.display = (bloc.style.display==='none'||bloc.style.display==='')?'block':'none';
}

// ---- Auto-resize textarea ----
document.addEventListener('input', e=>{if(e.target.tagName==='TEXTAREA') e.target.style.height='auto'; e.target.style.height=(e.target.scrollHeight)+'px';});
document.querySelectorAll('textarea').forEach(t=>{t.style.height='auto';t.style.height=(t.scrollHeight)+'px';});

// ---- PDF ----
document.getElementById('btnDownloadPDF').addEventListener('click', genererPDFGlobal);

async function genererPDFGlobal() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','pt','a4');
  const imgWidth = 595.28; const pageHeight=841.89; const marginTop=20; let yOffset=marginTop;
  async function captureElementToCanvas(element){
    const clone=element.cloneNode(true);
    const adminInClone=clone.querySelector('#adminPanel'); if(adminInClone) adminInClone.remove();
    const btnInClone=clone.querySelector('#btnDownloadPDF'); if(btnInClone) btnInClone.remove();
    clone.querySelectorAll('textarea').forEach(t=>{
      const div=document.createElement('div');
      div.style.whiteSpace='pre-wrap';
      div.style.minHeight=t.style.height||'auto';
      div.style.padding=window.getComputedStyle(t).padding||'6px';
      div.style.border='none';
      div.textContent=t.value||t.innerText||'';
      t.parentNode.replaceChild(div,t);
    });
    const wrapper=document.createElement('div');
    wrapper.style.position='fixed'; wrapper.style.left='-9999px'; wrapper.style.top='0'; wrapper.style.width=element.offsetWidth+'px';
    wrapper.appendChild(clone); document.body.appendChild(wrapper);
    const canvas=await html2canvas(clone,{scale:2,useCORS:true,scrollY:-window.scrollY,windowWidth:document.documentElement.scrollWidth});
    document.body.removeChild(wrapper); return canvas;
  }

  async function captureAndAdd(element,currentYOffset){
    const canvas=await captureElementToCanvas(element);
    const imgHeightPt=(canvas.height*imgWidth)/canvas.width;
    if(currentYOffset+imgHeightPt<=pageHeight){
      pdf.addImage(canvas.toDataURL('image/png'),'PNG',0,currentYOffset,imgWidth,imgHeightPt);
      return currentYOffset+imgHeightPt+10;
    } else {
      // Split canvas if too long
      let srcY=0; const pxPerPt=canvas.height/imgHeightPt; let yOffsetPt=currentYOffset;
      while(srcY<canvas.height){
        const spacePt=pageHeight-yOffsetPt; const srcSliceH=Math.floor(spacePt*pxPerPt);
        const tmpCanvas=document.createElement('canvas'); tmpCanvas.width=canvas.width; tmpCanvas.height=Math.min(srcSliceH,canvas.height-srcY);
        const ctx=tmpCanvas.getContext('2d'); ctx.drawImage(canvas,0,srcY,tmpCanvas.width,tmpCanvas.height,0,0,tmpCanvas.width,tmpCanvas.height);
        const dataUrl=tmpCanvas.toDataURL('image/png'); const drawHeightPt=(tmpCanvas.height*imgWidth)/tmpCanvas.width;
        pdf.addImage(dataUrl,'PNG',0,yOffsetPt,imgWidth,drawHeightPt);
        srcY+=tmpCanvas.height; if(srcY<canvas.height){pdf.addPage(); yOffsetPt=marginTop;} else yOffsetPt+=drawHeightPt+10;
      }
      return yOffsetPt;
    }
  }

  const enTeteEl=document.getElementById('enTetePDF');
  const instructionsEl=document.getElementById('instructionsPDF');
  if(enTeteEl) yOffset=await captureAndAdd(enTeteEl,yOffset);
  if(instructionsEl) yOffset=await captureAndAdd(instructionsEl,yOffset);

  const allBlocs=document.querySelectorAll('.bloc-formulaire');
  for(const bloc of allBlocs){
    const style=window.getComputedStyle(bloc);
    if(style.display==='none') continue;
    bloc.querySelectorAll('textarea').forEach(t=>{t.style.height='auto';t.style.height=(t.scrollHeight)+'px';});
    yOffset=await captureAndAdd(bloc,yOffset);
  }

  pdf.save('Decharge_CDENE.pdf');
}
</script>

</body>
</html>
 
